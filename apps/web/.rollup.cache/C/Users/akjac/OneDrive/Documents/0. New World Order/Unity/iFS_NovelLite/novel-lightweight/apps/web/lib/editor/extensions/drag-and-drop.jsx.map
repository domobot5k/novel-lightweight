{"version":3,"file":"drag-and-drop.jsx","sourceRoot":"","sources":["drag-and-drop.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Extension } from \"@tiptap/core\";\r\n\r\nimport { NodeSelection, Plugin } from \"@tiptap/pm/state\";\r\n// @ts-ignore\r\n// import { __serializeForClipboard, EditorView } from \"@tiptap/pm/view\";\r\n\r\nexport interface DragHandleOptions {\r\n  /**\r\n   * The width of the drag handle\r\n   */\r\n  dragHandleWidth: number;\r\n}\r\nfunction absoluteRect(node: Element) {\r\n  const data = node.getBoundingClientRect();\r\n\r\n  return {\r\n    top: data.top,\r\n    left: data.left,\r\n    width: data.width,\r\n  };\r\n}\r\n\r\nfunction nodeDOMAtCoords(coords: { x: number; y: number }) {\r\n  return document\r\n    .elementsFromPoint(coords.x, coords.y)\r\n    .find(\r\n      (elem: Element) =>\r\n        elem.parentElement?.matches?.(\".ProseMirror\") ||\r\n        elem.matches(\r\n          [\r\n            \"li\",\r\n            \"p:not(:first-child)\",\r\n            \"pre\",\r\n            \"blockquote\",\r\n            \"h1, h2, h3, h4, h5, h6\",\r\n          ].join(\", \")\r\n        )\r\n    );\r\n}\r\n\r\nfunction nodePosAtDOM(node: Element, view: EditorView) {\r\n  const boundingRect = node.getBoundingClientRect();\r\n\r\n  return view.posAtCoords({\r\n    left: boundingRect.left + 1,\r\n    top: boundingRect.top + 1,\r\n  })?.inside;\r\n}\r\n\r\nfunction DragHandle(options: DragHandleOptions) {\r\n  function handleDragStart(event: DragEvent, view: EditorView) {\r\n    view.focus();\r\n\r\n    if (!event.dataTransfer) return;\r\n\r\n    const node = nodeDOMAtCoords({\r\n      x: event.clientX + 50 + options.dragHandleWidth,\r\n      y: event.clientY,\r\n    });\r\n\r\n    if (!(node instanceof Element)) return;\r\n\r\n    const nodePos = nodePosAtDOM(node, view);\r\n    if (nodePos == null || nodePos < 0) return;\r\n\r\n    view.dispatch(\r\n      view.state.tr.setSelection(NodeSelection.create(view.state.doc, nodePos))\r\n    );\r\n\r\n    const slice = view.state.selection.content();\r\n\r\n// Skipping __serializeForClipboard because it's no longer available\r\nevent.dataTransfer.clearData();\r\nevent.dataTransfer.setData(\"text/plain\", \"Dragged content\");\r\nevent.dataTransfer.effectAllowed = \"copyMove\";\r\n\r\n\r\n    event.dataTransfer.setDragImage(node, 0, 0);\r\n\r\n    view.dragging = { slice, move: event.ctrlKey };\r\n  }\r\n\r\n  function handleClick(event: MouseEvent, view: EditorView) {\r\n    view.focus();\r\n\r\n    view.dom.classList.remove(\"dragging\");\r\n\r\n    const node = nodeDOMAtCoords({\r\n      x: event.clientX + 50 + options.dragHandleWidth,\r\n      y: event.clientY,\r\n    });\r\n\r\n    if (!(node instanceof Element)) return;\r\n\r\n    const nodePos = nodePosAtDOM(node, view);\r\n    if (!nodePos) return;\r\n\r\n    view.dispatch(\r\n      view.state.tr.setSelection(NodeSelection.create(view.state.doc, nodePos))\r\n    );\r\n  }\r\n\r\n  let dragHandleElement: HTMLElement | null = null;\r\n\r\n  function hideDragHandle() {\r\n    if (dragHandleElement) {\r\n      dragHandleElement.classList.add(\"hidden\");\r\n    }\r\n  }\r\n\r\n  function showDragHandle() {\r\n    if (dragHandleElement) {\r\n      dragHandleElement.classList.remove(\"hidden\");\r\n    }\r\n  }\r\n\r\n  return new Plugin({\r\n    view: (view) => {\r\n      dragHandleElement = document.createElement(\"div\");\r\n      dragHandleElement.draggable = true;\r\n      dragHandleElement.dataset.dragHandle = \"\";\r\n      dragHandleElement.classList.add(\"drag-handle\");\r\n      dragHandleElement.addEventListener(\"dragstart\", (e) => {\r\n        handleDragStart(e, view);\r\n      });\r\n      dragHandleElement.addEventListener(\"click\", (e) => {\r\n        handleClick(e, view);\r\n      });\r\n\r\n      hideDragHandle();\r\n\r\n      view?.dom?.parentElement?.appendChild(dragHandleElement);\r\n\r\n      return {\r\n        destroy: () => {\r\n          dragHandleElement?.remove?.();\r\n          dragHandleElement = null;\r\n        },\r\n      };\r\n    },\r\n    props: {\r\n      handleDOMEvents: {\r\n        mousemove: (view, event) => {\r\n          if (!view.editable) {\r\n            return;\r\n          }\r\n\r\n          const node = nodeDOMAtCoords({\r\n            x: event.clientX + 50 + options.dragHandleWidth,\r\n            y: event.clientY,\r\n          });\r\n\r\n          if (!(node instanceof Element) || node.matches(\"ul, ol\")) {\r\n            hideDragHandle();\r\n            return;\r\n          }\r\n\r\n          const compStyle = window.getComputedStyle(node);\r\n          const lineHeight = parseInt(compStyle.lineHeight, 10);\r\n          const paddingTop = parseInt(compStyle.paddingTop, 10);\r\n\r\n          const rect = absoluteRect(node);\r\n\r\n          rect.top += (lineHeight - 24) / 2;\r\n          rect.top += paddingTop;\r\n          // Li markers\r\n          if (node.matches(\"ul:not([data-type=taskList]) li, ol li\")) {\r\n            rect.left -= options.dragHandleWidth;\r\n          }\r\n          rect.width = options.dragHandleWidth;\r\n\r\n          if (!dragHandleElement) return;\r\n\r\n          dragHandleElement.style.left = `${rect.left - rect.width}px`;\r\n          dragHandleElement.style.top = `${rect.top}px`;\r\n          showDragHandle();\r\n        },\r\n        keydown: () => {\r\n          hideDragHandle();\r\n        },\r\n        mousewheel: () => {\r\n          hideDragHandle();\r\n        },\r\n        // dragging class is used for CSS\r\n        dragstart: (view) => {\r\n          view.dom.classList.add(\"dragging\");\r\n        },\r\n        drop: (view) => {\r\n          view.dom.classList.remove(\"dragging\");\r\n        },\r\n        dragend: (view) => {\r\n          view.dom.classList.remove(\"dragging\");\r\n        },\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\ninterface DragAndDropOptions {}\r\n\r\nconst DragAndDrop = Extension.create<DragAndDropOptions>({\r\n  name: \"dragAndDrop\",\r\n\r\n  addProseMirrorPlugins() {\r\n    return [\r\n      DragHandle({\r\n        dragHandleWidth: 24,\r\n      }),\r\n    ];\r\n  },\r\n});\r\n\r\nexport default DragAndDrop;\r\n"]}